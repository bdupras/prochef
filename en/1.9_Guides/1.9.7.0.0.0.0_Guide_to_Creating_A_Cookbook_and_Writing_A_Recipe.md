Guide to Creating A Cookbook and Writing A Recipe
=================================================

  

![image](../attachments/16089608/21463247.jpg)

You may want to also review the **[Cookbook Fast Start
Guide](Cookbook%20Fast%20Start%20Guide.html "Cookbook Fast Start Guide")**,
within the [Installation](Installation.html "Installation") section.

![image](../attachments/16089608/21463216.jpg)

Introduction
============

Opscode Team Member [Sean
OMeara](http://community.opscode.com/users/someara) put together a
[Brief Chef
Tutorial](http://blog.afistfulofservers.net/post/2011/03/16/a-brief-chef-tutorial-from-concentrate/)
on his personal blog. A portion of it is reproduced here, to provide an
example...

### From concept to release ... the birth of a NTP Cookbook.

Hello, NTP!
===========

A machine’s NTP client is simple to install and configure. Every systems
administrator is already familiar with it, which makes it a great
example.

Most software available as a native package in a given linux
distribution can be managed with a “package, template, service” design
pattern. Each of those words refers to a Chef
[resource](Resources.html "Resources"), which we pass arguments to.

### Step One : Creating an ntp cookbook

documentation reference

[How do I create a new
Cookbook?](Cookbooks.html#Cookbooks-HowdoIcreateanewCookbook%3F)

    $ knife cookbook create ntp

This creates a directory structure for the ntp cookbook. You can check
it out with ls:

    $ ls -la cookbooks/ntp/
    total 24
    drwxr-xr-x  13 someara  staff   442 Mar 14 17:56 .
    drwxr-xr-x  36 someara  staff  1224 Mar 15 19:39 ..
    -rw-r--r--   1 someara  staff    58 Mar 14 17:56 README.rdoc
    drwxr-xr-x   2 someara  staff    68 Mar 14 17:56 attributes
    drwxr-xr-x   2 someara  staff    68 Mar 14 17:56 definitions
    drwxr-xr-x   3 someara  staff   102 Mar 14 17:56 files
    drwxr-xr-x   2 someara  staff    68 Mar 14 17:56 libraries
    -rw-r--r--   1 someara  staff   259 Mar 14 17:56 metadata.rb
    drwxr-xr-x   2 someara  staff    68 Mar 14 17:56 providers
    drwxr-xr-x   4 someara  staff   136 Mar 14 17:56 recipes
    drwxr-xr-x   2 someara  staff    68 Mar 14 17:56 resources
    drwxr-xr-x   3 someara  staff   102 Mar 14 17:56 templates

### Step Two : Deciding what to name the recipe

documentation reference

[Using Recipes](Recipes.html#Recipes-UsingRecipes)

Recipe names are related to cookbook structure. Putting
`recipe[foo::bar]` in a node’s run list results in
`cookbooks/foo/recipes/bar.rb` being downloaded from chef-server and
executed.

There is a special recipe in every cookbook called `default.rb`. It is
executed by every recipe in the cookbook. Specifying `recipe[foo::bar]`
actually results in `cookbooks/foo/recipes/default.rb`, as well as
`cookbooks/foo/recipes/bar.rb` being executed.

Default.rb is a good place to put common stuff when writing cookbooks
with multiple recipes, but we’re going to keep it simple and just use
`default.rb` for everything.

### Step Three : Creating a recipe

documentation reference

[Recipes](Recipes.html "Recipes")

[Resources](Resources.html "Resources")

[Just Enough Ruby for
Chef](Just%20Enough%20Ruby%20for%20Chef.html "Just Enough Ruby for Chef")

This is where all the fun stuff happens. When using resources, you’re
writing things in a declarative fashion. Declarative means you can
concentrate on the WHAT without having to worry about the HOW. Chef will
take care of that for you with something called a resource provider.
When installing a package, it will check to see what your operating
system is and use the appropriate methodology. For example, on Debian
based systems, it will use apt-get, and on Redhat based systems, it will
use yum.

    $ vim cookbooks/ntp/recipes/default.rb

    package "ntp" do
        action [:install]
    end

    template "/etc/ntp.conf" do
        source "ntp.conf.erb"
        variables( :ntp_server => "time.nist.gov" )
        notifies :restart, "service[ntpd]"
    end

    service "ntpd" do
        action [:enable,:start]
    end

Chef recipes are evaluated top down (like a normal ruby program), with
each resource being ran in the order it appears. Order is important. In
the above example, if we were to reverse the order of those three
resources, it would first fail to start the service (as the software is
not installed yet), then write the configuration file, then finally
clobber the file it just wrote by installing the package.

### Step Four : Creating the ntp.conf.erb template

documentation reference

[Customizing Templates and
Files](Cookbooks.html#Cookbooks-CustomizingTemplatesandFiles)

[Templates](Templates.html "Templates")

    $ vim cookbooks/ntp/templates/default/ntp.conf.erb

    # generated by Chef.
    restrict default kod nomodify notrap nopeer noquery
    restrict -6 default kod nomodify notrap nopeer noquery
    restrict 127.0.0.1
    restrict -6 ::1
    server <%= @ntp_server %>
    server  127.127.1.0     # local clock
    driftfile /var/lib/ntp/drift
    keys /etc/ntp/keys

### Step Five : uploading the cookbook to chef-server

documentation reference

[How do I upload my cookbooks to the Chef
Server?](Cookbooks.html#Cookbooks-HowdoIuploadcookbookstotheChefServer%253F)

    $ knife cookbook upload ntp

![image](images/icons/emoticons/information.gif)

**Want Another Example on Writing a Chef Cookbook?**  
![image](../attachments/16089608/21463217.png)

  
 For another guide, Opscode teammate [Joshua
Timberman](http://jtimberman.posterous.com/) has **[Guide to Writing
Chef
Cookbooks](http://jtimberman.posterous.com/guide-to-writing-chef-cookbooks)**
on his personal blog. Check it out for an additional tutorial on
building a cookbook for automation of your infrastructure.

More?
=====

For more of the tutorial from Sean, see **[A Brief Chef Tutorial (from
concentrate)](http://blog.afistfulofservers.net/post/3902042503/a-brief-chef-tutorial-from-concentrate)**.
For more information on any of the steps above, see the documentation
reference listed.

  
  
  
  

  
