Templates
=========

  

Overview
========

![image](images/icons/emoticons/information.gif)

**Chef Templates Just ERB (only faster!)**  
  
 Chef utilizes [Erubis](http://www.kuwata-lab.com/erubis/) for our
templates - for those of you coming from the Rails, Merb, or Puppet
communities, this means it's just ERB (only faster!).   

![image](../attachments/1179825/21463237.png)

#### Templates get used all the time in Chef! We love templates. A template is a file written in a markup language that allows one to dynamically generate the file's final content based on variables or more complex logic. Templates are commonly used to manage configuration files with Chef.

##### You utilize a template by adding a [template resource](Resources.html#Resources-Template) to a [recipe](Recipes.html "Recipes") and creating a corresponding ERB template in the [cookbook](Cookbooks.html "Cookbooks").

  
 For example, the following template and [template
resource](Resources.html#Resources-ResourcesTemplate) may be used to
manage the `/etc/sudoers` configuration file on your nodes. This example
depends on node [attributes](Attributes.html "Attributes") that have to
be set before running the cookbook. Within a "sudo" cookbook, we might
place the following resource within `recipes/default.rb` and save the
template as `templates/default/sudoers.erb`:

**A template resource (recipes/default.rb)**

    template "/etc/sudoers" do
      source "sudoers.erb"
      mode 0440
      owner "root"
      group "root"
      variables({
        :sudoers_groups => node[:authorization][:sudo][:groups],
        :sudoers_users => node[:authorization][:sudo][:users]
      })
    end

**A template (templates/default/sudoers.erb)**

    #
    # /etc/sudoers
    #
    # Generated by Chef for <%= node[:fqdn] %>
    #

    Defaults        !lecture,tty_tickets,!fqdn

    # User privilege specification
    root          ALL=(ALL) ALL

    <% @sudoers_users.each do |user| -%>
    <%= user %>   ALL=(ALL) <%= "NOPASSWD:" if @passwordless %>ALL
    <% end -%>

    # Members of the sysadmin group may gain root privileges
    %sysadmin     ALL=(ALL) <%= "NOPASSWD:" if @passwordless %>ALL

    <% @sudoers_groups.each do |group| -%>
    # Members of the group '<%= group %>' may gain root privileges
    %<%= group %> ALL=(ALL) <%= "NOPASSWD:" if @passwordless %>ALL
    <% end -%>

Before this cookbook would work, we would also need to set the
[attributes](Attributes.html "Attributes"):

**Default attributes (attributes/default.rb)**

    default["authorization"]["sudo"]["groups"] = [ "sysadmin","wheel","admin" ]
    default["authorization"]["sudo"]["users"]  = [ "jerry","greg"]

Variables and ERB
=================

Chef templates are ERB templates. ERB templates allow you to embed Ruby
code inside a text file within specially formated tags:

**An ERB Template**

    Plain text content
    <%= RUBY EXPRESSIONS GO HERE %>
    <% RUBY STATEMENTS GO HERE -%>
    More plain text content

When rendered, the ruby code delimitated by `<%=` and `%>` is evaluated
and its output is placed in the final text file. You will mostly be
using Ruby Expressions, as this is how you reference any variables you
sent to the template. You can also use Ruby Statements though, such as
each, if or end statements. These are surrounded by `<%` and `-%>`
instead.

When a template is rendered, Chef passes the variables listed in the
resource's `variables` attribute and the `node` object to the template.
The variables will be accessible as **instance variables** within the
template while the node object can be accessed just as it can be in a
recipe, using the name `node`.

**For example:**

**Simple template resource**

    node[:fqdn] = "latte"
    template "/tmp/foo" do
      source "foo.erb"
      variables({
        :x_men => "are keen"
      })
    end

**Simple ERB template**

    The node <%= node[:fqdn] %> thinks the x-men <%= @x_men %>

Would render:

**Rendered template**

    The node latte thinks the x-men are keen

As can be seen in the example present in the
[Overview](#Templates-Overiew), more complex Ruby features can be used
to dynamically generate configuration files using the data passed to the
template resource. **For more information about how to use ERB,**
**[check out the Erubis
Documentation](http://www.kuwata-lab.com/erubis/users-guide.html)****.**

Template Location Specificity
=============================

[Cookbooks](Cookbooks.html "Cookbooks") are often designed to work on a
variety of hosts and platforms. Templates often need to differ depending
on the platform, host, or function of the node. When the differences are
minor, they can be handled with a small amount of logic within the
template itself. When templates differ dramatically, you can define
multiple templates for the same file. Chef will decide which template to
render based on the following rules.

Within a Cookbook's template directory, you might find a directory
structure like this:

-   templates
    -   host-foo.example.com
    -   ubuntu-8.04
    -   ubuntu
    -   default

For a node with FQDN of foo.example.com and the `sudoers.erb` resource
above, we would match:

-   host-foo.example.com/sudoers.erb
-   ubuntu-8.04/sudoers.erb
-   ubuntu/sudoers.erb
-   default/sudoers.erb

*In that order.*

Then, for example: `sudoers.rb` placed under the
`files/host-foo.example.com/` directory, means it will be only copied to
the machine with the domain name `foo.example.com`. (Note the "host-"
prefix to the directory name)

**So, the rule distilled:**

1.  `host-node[:fqdn]`
2.  `node[:platform]-node[:platform_version]`
3.  `node[:platform]`
4.  `default`

('default' here does not refer to the recipe in default.rb. Templates
are not split up into different directories by recipe.)

Additionally, when using a cookbook downloaded from the community site,
it is possible to override individual templates within that cookbook
using [Site Specific
Cookbooks](http://wiki.opscode.com/display/chef/Cookbooks#Cookbooks-SiteSpecificCookbooks).
Note, however, that this feature is being deprecated.

  

![image](images/icons/emoticons/information.gif)

**Host Notation**  
The **host-** is literal. If your host was `foo.example.com` than your
folder needs to be named `host-foo.example.com`.

![image](images/icons/emoticons/check.gif)

**Hey, Cfengine people!**  
This is inspired by [Single Copy
Nirvana](http://cfwiki.org/cfwiki/index.php/Singlecopy_Nirvana) - if you
think about it that way, this will click immediately.

When does a template get transferred?
-------------------------------------

Chef caches a template when it is first requested. On all subsequent
requests for that template, we compare that to the template on the
server - if they are the same, we won't transfer the entire template
again.

### Use Case Scenario

***We have an Apache cookbook writing out httpd.conf, then we have an
application under site-cookbooks that needs its own very custom
httpd.conf. How do we have the site cookbook override the httpd.conf
template?***

Review the [\`cookbook\` attribute for the \`template\`
resource](http://wiki.opscode.com/display/chef/Resources#Resources-Template).
Use of this attribute allows you to specify an alternate cookbook in
which to look for a template. You could therefore create application
specific cookbooks that hold app-specific versions of the template in
question. Usually the core \`httpd.conf\` file doesn't change between
applications, but the vhost conf file may differ heavily.

For example, [the \`web\_app\`
definition](https://github.com/opscode/cookbooks/blob/master/apache2/definitions/web_app.rb)
that is found within the [Opscode apache2
cookbook](http://community.opscode.com/cookbooks/apache2) is meant to
simplify the process of creating an app specific vhost:

**The web\_app definition**

    define :web_app, :template => "web_app.conf.erb" do

      application_name = params[:name]

      include_recipe "apache2"
      include_recipe "apache2::mod_rewrite"
      include_recipe "apache2::mod_deflate"
      include_recipe "apache2::mod_headers"

      template "#{node[:apache][:dir]}/sites-available/#{application_name}.conf" do
        source params[:template]
        owner "root"
        group "root"
        mode 0644
        if params[:cookbook]
          cookbook params[:cookbook]
        end
        variables({
          :application_name => application_name,
          :params => params
        })
        if ::File.exists?("#{node[:apache][:dir]}/sites-enabled/#{application_name}.conf")
          notifies :reload, resources(:service => "apache2"), :delayed
        end
      end

      apache_site "#{params[:name]}.conf" do
        enable enable_setting
      end
    end

The [Opscode wordpress
cookbook](http://community.opscode.com/cookbooks/wordpress) has a great
example of using this definition:

**Use of the web\_app definition**

    (...)

      web_app "wordpress" do
        template "wordpress.conf.erb"
        docroot "#{node['wordpress']['dir']}"
        server_name server_fqdn
        server_aliases node['fqdn']
      end

  
  
  
  

  

Is there a clean way to define a library method so that it is in scope
in a resource, for example to pass as a variable to a template? The only
way I've come up with is to assign the library method to a local
variable, which is annoying.

![image](images/icons/comment_16.gif) Posted by lastobelus at May 02,
2010 09:41

Thanks so much for Chef.

The sudoer example would be a bit more helpful if it was shown how to,
for example, set the

    node[:authorization][:sudo][:groups]

attribute. I cannot find in the Chef wiki how to set an attribute to
include multiple values. In the sudoer groups example, I need to set
that attribute to include the following list:

ServerAdmins  
 ServerAdmins2  
 ServerAdmins3

How do I set the attribute?

![image](images/icons/comment_16.gif) Posted by ian.d.rossi@gmail.com at
Feb 03, 2012 20:20

Looking at the README.md in the source code of the sudo cookbook
explained it.

[http://community.opscode.com/cookbooks/sudo/source](http://community.opscode.com/cookbooks/sudo/source)

![image](images/icons/comment_16.gif) Posted by ian.d.rossi@gmail.com at
Feb 03, 2012 20:30
