<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Chef : Templates</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Chef : Templates
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Aug 03, 2012 by <font color="#0050B2">jtimberman</font>.
				    </div>

				    <table class="sectionMacro" border="0" cellpadding="5" cellspacing="0" width="100%"><tbody><tr>
<td class="confluenceTd" valign="top" width="3%"></td>
<td class="confluenceTd" valign="top">
<p><br class="atl-forced-newline" /></p>

<h1><a name="Templates-Overview"></a>Overview</h1>
<p><div class='navmenu' style='float:right; width:220px; background:#eeeeee; margin:10px; padding:3px'><div class='panelMacro'><table class='infoMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td><b>Chef Templates Just ERB (only faster!)</b><br /><br class="atl-forced-newline" />
Chef utilizes <a href="http://www.kuwata-lab.com/erubis/">Erubis</a> for our templates - for those of you coming from the Rails, Merb, or Puppet communities, this means it's just ERB (only faster!).
<br class="atl-forced-newline" /></td></tr></table></div></div> <span class="image-wrap" style="float: left"><img src="../attachments/1179825/21463237.png" hspace="16" vspace="6" style="border: 0px solid black"/></span></p>

<h4><a name="Templates-"></a><font color="#f7681a">Templates get used all the time in Chef&#33;  We love templates.</font> <font color="#f7681a">A template is a file written in a markup language that allows one to dynamically generate the file's final content based on variables or more complex logic.  Templates are commonly used to manage configuration files with Chef.</font></h4>

<h5><a name="Templates-YouutilizeatemplatebyaddingatemplateresourceResources%23TemplatetoarecipeRecipesandcreatingacorrespondingERBtemplateinthecookbookCookbooks."></a>You utilize a template by adding a <a href="Resources.html#Resources-Template">template resource</a> to a <a href="Recipes.html" title="Recipes">recipe</a> and creating a corresponding ERB template in the <a href="Cookbooks.html" title="Cookbooks">cookbook</a>.</h5>

<p><br class="atl-forced-newline" />
For example, the following template and <a href="Resources.html#Resources-ResourcesTemplate">template resource</a> may be used to manage the <tt>/etc/sudoers</tt> configuration file on your nodes.  This example depends on node <a href="Attributes.html" title="Attributes">attributes</a> that have to be set before running the cookbook.  Within a "sudo" cookbook, we might place the following resource within <tt>recipes/default.rb</tt> and save the template as <tt>templates/default/sudoers.erb</tt>:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>A template resource (recipes/default.rb)</b></div><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: ruby; gutter: false">template "/etc/sudoers" do
  source "sudoers.erb"
  mode 0440
  owner "root"
  group "root"
  variables({
    :sudoers_groups =&gt; node[:authorization][:sudo][:groups],
    :sudoers_users =&gt; node[:authorization][:sudo][:users]
  })
end</pre>
		</div>
</div></div>
<div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>A template (templates/default/sudoers.erb)</b></div><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: ruby; gutter: false">#
# /etc/sudoers
#
# Generated by Chef for &lt;%= node[:fqdn] %&gt;
#

Defaults        !lecture,tty_tickets,!fqdn

# User privilege specification
root          ALL=(ALL) ALL

&lt;% @sudoers_users.each do |user| -%&gt;
&lt;%= user %&gt;   ALL=(ALL) &lt;%= "NOPASSWD:" if @passwordless %&gt;ALL
&lt;% end -%&gt;

# Members of the sysadmin group may gain root privileges
%sysadmin     ALL=(ALL) &lt;%= "NOPASSWD:" if @passwordless %&gt;ALL

&lt;% @sudoers_groups.each do |group| -%&gt;
# Members of the group '&lt;%= group %&gt;' may gain root privileges
%&lt;%= group %&gt; ALL=(ALL) &lt;%= "NOPASSWD:" if @passwordless %&gt;ALL
&lt;% end -%&gt;</pre>
		</div>
</div></div>

<p>Before this cookbook would work, we would also need to set the <a href="Attributes.html" title="Attributes">attributes</a>:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>Default attributes (attributes/default.rb)</b></div><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: ruby; gutter: false">default["authorization"]["sudo"]["groups"] = [ "sysadmin","wheel","admin" ]
default["authorization"]["sudo"]["users"]  = [ "jerry","greg"]</pre>
		</div>
</div></div>


<h1><a name="Templates-VariablesandERB"></a>Variables and ERB</h1>

<p><font color="#f7681a">Chef templates are ERB templates.</font> ERB templates allow you to embed Ruby code inside a text file within specially formated tags:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>An ERB Template</b></div><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">Plain text content
&lt;%= RUBY EXPRESSIONS GO HERE %&gt;
&lt;% RUBY STATEMENTS GO HERE -%&gt;
More plain text content</pre>
		</div>
</div></div>

<p>When rendered, the ruby code delimitated by <tt>&lt;%=</tt> and <tt>%&gt;</tt> is evaluated and its output is placed in the final text file. You will mostly be using Ruby Expressions, as this is how you reference any variables you sent to the template. You can also use Ruby Statements though, such as each, if or end statements. These are surrounded by <tt>&lt;%</tt> and <tt>&#45;%&gt;</tt> instead.</p>

<p><font color="#f7681a">When a template is rendered, Chef passes the variables listed in the resource's</font> <font color="#f7681a"><tt>variables</tt></font> <font color="#f7681a">attribute and the</font> <font color="#f7681a"><tt>node</tt></font> <font color="#f7681a">object to the template.</font> The variables will be accessible as <b>instance variables</b> within the template while the node object can be accessed just as it can be in a recipe, using the name <tt>node</tt>.</p>

<p><b>For example:</b></p>

<div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>Simple template resource</b></div><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: ruby; gutter: false">node[:fqdn] = "latte"
template "/tmp/foo" do
  source "foo.erb"
  variables({
    :x_men =&gt; "are keen"
  })
end</pre>
		</div>
</div></div>

<div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>Simple ERB template</b></div><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: text; gutter: false">The node &lt;%= node[:fqdn] %&gt; thinks the x-men &lt;%= @x_men %&gt;</pre>
		</div>
</div></div>

<p>Would render:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>Rendered template</b></div><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: text; gutter: false">The node latte thinks the x-men are keen</pre>
		</div>
</div></div>

<p>As can be seen in the example present in the <a href="#Templates-Overiew">Overview</a>, more complex Ruby features can be used to dynamically generate configuration files using the data passed to the template resource. <b>For more information about how to use ERB,</b> <b><a href="http://www.kuwata-lab.com/erubis/users-guide.html">check out the Erubis Documentation</a></b><b>.</b></p>

<h1><a name="Templates-TemplateLocationSpecificity"></a>Template Location Specificity</h1>

<p><a href="Cookbooks.html" title="Cookbooks">Cookbooks</a> are often designed to work on a variety of hosts and platforms.  Templates often need to differ depending on the platform, host, or function of the node.  When the differences are minor, they can be handled with a small amount of logic within the template itself. <font color="#f7681a">When templates differ dramatically, you can define multiple templates for the same file.</font> Chef will decide which template to render based on the following rules.</p>

<p>Within a Cookbook's template directory, you might find a directory structure like this:</p>

<ul>
	<li>templates
	<ul>
		<li>host-foo.example.com</li>
		<li>ubuntu-8.04</li>
		<li>ubuntu</li>
		<li>default</li>
	</ul>
	</li>
</ul>


<p>For a node with FQDN of foo.example.com and the <tt>sudoers.erb</tt> resource above, we would match:</p>

<ul>
	<li>host-foo.example.com/sudoers.erb</li>
	<li>ubuntu-8.04/sudoers.erb</li>
	<li>ubuntu/sudoers.erb</li>
	<li>default/sudoers.erb</li>
</ul>


<p><em>In that order.</em></p>

<p>Then, for example: <tt>sudoers.rb</tt> placed under the <tt>files/host-foo.example.com/</tt> directory, means it will be only copied to the machine with the domain name <tt>foo.example.com</tt>. (Note the "host-" prefix to the directory name)</p>

<p><b>So, the rule distilled:</b></p>

<ol>
	<li><tt>host-node[:fqdn]</tt></li>
	<li><tt>node[:platform]-node[:platform_version]</tt></li>
	<li><tt>node[:platform]</tt></li>
	<li><tt>default</tt></li>
</ol>


<p>('default' here does not refer to the recipe in default.rb. Templates are not split up into different directories by recipe.)</p>

<p>Additionally, when using a cookbook downloaded from the community site, it is possible to override individual templates within that cookbook using <a href="http://wiki.opscode.com/display/chef/Cookbooks#Cookbooks-SiteSpecificCookbooks">Site Specific Cookbooks</a>.  Note, however, that this feature is being deprecated.</p>

<p><br class="atl-forced-newline" /></p>
<div class='panelMacro'><table class='infoMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td><b>Host Notation</b><br />The <b>host&#45;</b> is literal. If your host was <tt>foo.example.com</tt> than your folder needs to be named <tt>host-foo.example.com</tt>.</td></tr></table></div>

<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td><b>Hey, Cfengine people!</b><br />This is inspired by <a href="http://cfwiki.org/cfwiki/index.php/Singlecopy_Nirvana">Single Copy Nirvana</a> &#45; if you think about it that way, this will click immediately.</td></tr></table></div>

<h2><a name="Templates-Whendoesatemplategettransferred%3F"></a>When does a template get transferred?</h2>

<p><font color="#f7681a">Chef caches a template when it is first requested.</font> On all subsequent requests for that template, we compare that to the template on the server - if they are the same, we won't transfer the entire template again.</p>

<h3><a name="Templates-UseCaseScenario"></a>Use Case Scenario</h3>

<p><font color="navy"><b><em>We have an Apache cookbook writing out httpd.conf, then we have an application under site-cookbooks that needs its own very custom httpd.conf.  How do we have the site cookbook override the httpd.conf template?</em></b></font></p>

<p>Review the <a href="http://wiki.opscode.com/display/chef/Resources#Resources-Template">`cookbook` attribute for the `template` resource</a>.  Use of this attribute allows you to specify an alternate cookbook in which to look for a template. You could therefore create application specific cookbooks that hold app-specific versions of the template in question.  Usually the core `httpd.conf` file doesn't change between applications, but the vhost conf file may differ heavily.</p>

<p>For example, <a href="https://github.com/opscode/cookbooks/blob/master/apache2/definitions/web_app.rb">the `web_app` definition</a> that is found within the <a href="http://community.opscode.com/cookbooks/apache2">Opscode apache2 cookbook</a> is meant to simplify the process of creating an app specific vhost:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>The web_app definition</b></div><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: ruby; gutter: false">define :web_app, :template =&gt; "web_app.conf.erb" do

  application_name = params[:name]

  include_recipe "apache2"
  include_recipe "apache2::mod_rewrite"
  include_recipe "apache2::mod_deflate"
  include_recipe "apache2::mod_headers"

  template "#{node[:apache][:dir]}/sites-available/#{application_name}.conf" do
    source params[:template]
    owner "root"
    group "root"
    mode 0644
    if params[:cookbook]
      cookbook params[:cookbook]
    end
    variables({
      :application_name =&gt; application_name,
      :params =&gt; params
    })
    if ::File.exists?("#{node[:apache][:dir]}/sites-enabled/#{application_name}.conf")
      notifies :reload, resources(:service =&gt; "apache2"), :delayed
    end
  end

  apache_site "#{params[:name]}.conf" do
    enable enable_setting
  end
end</pre>
		</div>
</div></div>

<p>The <a href="http://community.opscode.com/cookbooks/wordpress">Opscode wordpress cookbook</a> has a great example of using this definition:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>Use of the web_app definition</b></div><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: ruby; gutter: false">(...)

  web_app "wordpress" do
    template "wordpress.conf.erb"
    docroot "#{node['wordpress']['dir']}"
    server_name server_fqdn
    server_aliases node['fqdn']
  end</pre>
		</div>
</div></div>

<p><br class="atl-forced-newline" />
<br class="atl-forced-newline" />
<br class="atl-forced-newline" />
<br class="atl-forced-newline" /></p></td>
<td class="confluenceTd" valign="top" width="5%"></td></tr></tbody></table>
<table class="sectionMacro" border="0" cellpadding="5" cellspacing="0" width="100%"><tbody><tr>

<hr />
<td class="confluenceTd" valign="top" width="45%">

<p><a href="Unix Environment Variables and Chef Recipes.html" title="Unix Environment Variables and Chef Recipes"><span class="image-wrap" style="float: left"><img src="../attachments/1179825/20840602.png" hspace="4" style="border: 0px solid black"/></span> Unix Environment Variables and Chef Recipes </a></p>
</td>
<td class="confluenceTd" valign="top" width="40%"></td>

<td class="confluenceTd" valign="top" width="15%">

<p><a href="Version Constraints.html" title="Version Constraints"><span class="image-wrap" style="float: right"><img src="../attachments/1179825/20840601.png" hspace="4" style="border: 0px solid black"/></span> Version Constraints </a></p>

<p><br class="atl-forced-newline" />
<br class="atl-forced-newline" /></p></td></tr></tbody></table>

				    					    <br/>
                        <div class="tabletitle">
                            <a name="attachments">
                                <h2>Attachments:</h2>
                            </a>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="../attachments/1179825/16187410.jpg">template.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="../attachments/1179825/16187411.jpg">templates.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="../attachments/1179825/20840601.png">rightarrow.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="../attachments/1179825/20840602.png">leftarrow.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="../attachments/1179825/21463237.png">templates.png</a> (image/png)
                                <br/>
                                                    </div>
				    
                                            <div class="tabletitle">
                            <a name="comments">
                                <h2>Comments:</h2>
                            </a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-5898435"></a>
                                    <font class="smallfont"><p>Is there a clean way to define a library method so that it is in scope in a resource, for example to pass as a variable to a template? The only way I've come up with is to assign the library method to a local variable, which is annoying.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by lastobelus at May 02, 2010 09:41
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23429564"></a>
                                    <font class="smallfont"><p>Thanks so much for Chef.</p>

<p>The sudoer example would be a bit more helpful if it was shown how to, for example, set the</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">node[:authorization][:sudo][:groups]</pre>
		</div>
</div></div>
<p>attribute. I cannot find in the Chef wiki how to set an attribute to include multiple values. In the sudoer groups example, I need to set that attribute to include the following list:</p>

<p>ServerAdmins<br/>
ServerAdmins2<br/>
ServerAdmins3</p>

<p>How do I set the attribute?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by ian.d.rossi@gmail.com at Feb 03, 2012 20:20
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23429567"></a>
                                    <font class="smallfont"><p>Looking at the README.md in the source code of the sudo cookbook explained it.</p>

<p><a href="http://community.opscode.com/cookbooks/sudo/source">http://community.opscode.com/cookbooks/sudo/source</a></p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by ian.d.rossi@gmail.com at Feb 03, 2012 20:30
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://wiki.opscode.com/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Aug 04, 2012 00:03</font></td>
		    </tr>
	    </table>
    </body>
</html>
